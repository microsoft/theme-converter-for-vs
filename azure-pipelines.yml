name: $(date:yy)$(DayOfYear)$(rev:.r)
trigger:
  branches:
    include:
    - main
pr:
  branches:
    include:
    - main
  drafts: false
variables:
- name: SolutionFile
  value: ThemeConverter/ThemeConverter.sln
- name: Platform
  value: Any CPU
- name: BuildConfiguration
  value: Release
- name: ProductBinariesFolder
  value: '$(System.DefaultWorkingDirectory)/ThemeConverter/ThemeConverter/bin/$(BuildConfiguration)/net6.0'
- name: VersionMajor
  value: 0
- name: VersionMinor
  value: 1
- name: AssemblyVersion
  value: $(VersionMajor).$(VersionMinor).0.0
- name: ProductVersion
  value: $(VersionMajor).$(VersionMinor).$(Build.BuildNumber)
- name: SignType
  value: Test
resources:
  repositories:
  - repository: MicroBuildTemplate
    type: git
    name: 1ESPipelineTemplates/MicroBuildTemplate
    ref: refs/tags/release
extends:
  template: azure-pipelines/MicroBuild.1ES.Official.yml@MicroBuildTemplate
  parameters:
    sdl:
      policheck:
        enabled: true
    pool:
      name: VSEngSS-MicroBuild2022-1ES
      demands:
      - msbuild
      - VisualStudio_17.0
    customBuildTags:
    - ES365AIMigrationTooling
    stages:
    - stage: stage
      jobs:
      - job: Build_And_Compliance
        displayName: Build and Compliance
        templateContext:
          mb:
            signing:
              enabled: true
              feedSource: 'https://devdiv.pkgs.visualstudio.com/DefaultCollection/_packaging/MicroBuildToolset/nuget/v3/index.json'
              signType: $(SignType)
          outputs:
          - output: pipelineArtifact
            displayName: 'Publish Staging Directory'
            targetPath: $(Build.StagingDirectory)
        steps:
        - checkout: self
          clean: true
        - task: NuGetCommand@2
          displayName: Restore NuGet Packages
          inputs:
            command: 'restore'
            restoreSolution: $(SolutionFile)
        - task: MSBuild@1
          displayName: Build Product
          inputs:
            solution: $(SolutionFile)
            platform: $(Platform)
            configuration: $(BuildConfiguration)
            msbuildArguments: /Property:Version=$(ProductVersion) /Property:FileVersion=$(ProductVersion) /Property:AssemblyVersion=$(AssemblyVersion) /Property:SignType=$(SignType)
          continueOnError: false
        - task: ComponentGovernanceComponentDetection@0
          displayName: Run Component Detection
          inputs:
            scanType: 'Register'
            verbosity: 'Verbose'
            alertWarningLevel: 'High'
          condition: succeededOrFailed()
          continueOnError: True
        - task: RoslynAnalyzers@2
          displayName: Run Roslyn Analyzers. {Required and Recommended}
          inputs:
            internalAnalyzersVersion: Latest
            microsoftAnalyzersVersion: Latest
          condition: succeededOrFailed()
          continueOnError: True
        - task: DotNetCoreCLI@2
          displayName: Run Tests
          inputs:
            command: 'test'
            projects: '**/ThemeConverterTests.csproj'
            arguments: '--configuration Release'
        - task: AntiMalware@4
          displayName: Run Anti-Malware Scan
          inputs:
            InputType: 'Basic'
            ScanType: 'CustomScan'
            FileDirPath: '$(Build.StagingDirectory)'
            EnableServices: true
            TreatSignatureUpdateFailureAs: 'Warning'
            SignatureFreshness: 'UpToDate'
            TreatStaleSignatureAs: 'Error'
          condition: succeededOrFailed()
          continueOnError: True
        - task: CredScan@2
          displayName: Run CredScan
          inputs:
            toolMajorVersion: V2
          condition: succeededOrFailed()
          continueOnError: True
        - task: PoliCheck@1
          displayName: Run PoliCheck
          inputs:
            importEx: 0
            optionsFC: 1
          condition: succeededOrFailed()
          continueOnError: True
        - task: TSAUpload@1
          displayName: TSA Upload
          inputs:
            tsaVersion: TsaV2
            codebase: NewOrUpdate
            codeBaseName: Theme Converter for VS
            notificationAlias: vspersonalization@microsoft.com
            codeBaseAdmins: redmond\ketyang;redmond\huvalo;redmond\jekelly;redmond\naesteve
            instanceUrlForTsaV2: DEVDIV
            projectNameDEVDIV: DevDiv
            areaPath: DevDiv\VS Core\IDE Experience\Theming
            iterationPath: DevDiv
            uploadCredScan: true
            uploadPoliCheck: true
            uploadRoslyn: true
            uploadAPIScan: false
            uploadBinSkim: false
            uploadFortifySCA: false
            uploadFxCop: false
            uploadModernCop: false
            uploadPREfast: false
            uploadTSLint: false
        - task: ArchiveFiles@2
          displayName: Archive Binaries
          inputs:
            rootFolderOrFile: '$(ProductBinariesFolder)'
            includeRootFolder: true
            archiveType: 'zip'
            archiveFile: '$(Build.StagingDirectory)/ThemeConverter-$(VersionMajor).$(VersionMinor).$(Build.BuildNumber).zip'
            replaceExistingArchive: true